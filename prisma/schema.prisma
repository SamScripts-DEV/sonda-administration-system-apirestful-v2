// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  users       User[]
  @@map("department")
}

model Position {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  users       User[]
  @@map("position")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  scope       String    //"GLOBAL" o "LOCAL"
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  users       UserRole[]
  permissions RolePermission[]
  areaRoles   AreaRole[]
  userRoleLocals UserRoleLocal[]
  @@map("role")
}

model Permission {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String?
  description String?
  module      String
  group       String?
  priority    Int?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  roles       RolePermission[]
  @@map("permission")
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@id([roleId, permissionId])
  @@map("role_permission")
}

model User {
  id           String   @id @default(uuid())
  firstName    String
  lastName     String
  username     String   @unique
  email        String   @unique
  passwordHash String
  phone        String[]
  active       Boolean  @default(true)
  nationalId   String  @unique
  imageUrl     String?
  address      String?
  city         String?
  country      String?
  province     String?
  departmentId String
  positionId   String?
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @db.Timestamptz(6)
  lastLogin    DateTime? @db.Timestamptz(6)
  department   Department @relation(fields: [departmentId], references: [id])
  position     Position?  @relation(fields: [positionId], references: [id])
  areas        UserArea[]
  roles        UserRole[]
  roles_local  UserRoleLocal[]
  tokens       Token[]
  vacationRequests VacationRequest[] @relation("VacationUser")
  createdVacationRequests VacationRequest[] @relation("VacationCreatedBy")
  vacationBalances VacationBalance[]
  vacationActions VacationActionLog[] @relation("VacationActionBy")
  salaryHistory SalaryHistory[]
  shiftAssignments ShiftAssignment[] @relation("UserShiftAssignments")
  originalShiftAssignments ShiftAssignment[] @relation("OriginalUser")
  shiftEvents ShiftEvent[]
  userTechnicalLevels UserTechnicalLevel[]
  organizationalGroups  UserOrganizationalGroup[]
  @@map("users")
}

model UserRole {
  userId String
  roleId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  @@id([userId, roleId])
  @@map("user_role")
}

model UserRoleLocal {
  id      String @id @default(uuid())
  userId  String
  areaId String
  roleId  String // Solo roles con scope "LOCAL"
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  area    Area  @relation(fields: [areaId], references: [id])
  role    Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  @@map("user_role_local")
}

model Area {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  userAreas  UserArea[] 
  areaRoles  AreaRole[] 
  userRoleLocals UserRoleLocal[]
  shiftAssignments ShiftAssignment[]
  organizationalGroups  OrganizationalGroup[]
  @@map("area")
}

model UserArea {
  id        String @id @default(uuid())
  userId    String
  areaId   String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  area      Area  @relation(fields: [areaId], references: [id])
  @@map("user_area")
}

model Token {
  id         String   @id @default(uuid())
  userId     String
  type       String
  tokenHash  String
  expiresAt  DateTime @db.Timestamptz(6)
  used       Boolean  @default(false)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("token")
}

model Holiday {
  id          String   @id @default(uuid())
  name        String
  startDate   DateTime @db.Timestamptz(6)
  endDate     DateTime @db.Timestamptz(6)
  observation String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @db.Timestamptz(6)
  @@map("holiday")
}

model VacationRequest {
  id            String   @id @default(uuid())
  userId        String
  createdById   String
  startDate     DateTime @db.Timestamptz(6)
  endDate       DateTime @db.Timestamptz(6)
  daysRequested Int
  status        String   // "PENDING", "APPROVED", "REJECTED"
  observation   String?
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @db.Timestamptz(6)
  user          User     @relation("VacationUser", fields: [userId], references: [id])
  createdBy     User     @relation("VacationCreatedBy", fields: [createdById], references: [id])
  actions       VacationActionLog[]
  @@map("vacation_request")
}

model VacationBalance {
  id            String   @id @default(uuid())
  userId        String
  year          Int
  daysAvailable Int
  daysTaken     Int      @default(0)
  daysOwed      Int      @default(0)
  updatedAt     DateTime @default(now()) @db.Timestamptz(6)
  user          User     @relation(fields: [userId], references: [id])
  @@map("vacation_balance")
}

model VacationActionLog {
  id                String   @id @default(uuid())
  vacationRequestId String
  action            String   // "APPROVED", "REJECTED"
  actionById        String
  actionAt          DateTime @default(now()) @db.Timestamptz(6)
  comment           String?
  vacationRequest   VacationRequest @relation(fields: [vacationRequestId], references: [id])
  actionBy          User     @relation("VacationActionBy", fields: [actionById], references: [id])
  @@map("vacation_action_log")
}

model AreaRole {
  id      String @id @default(uuid())
  areaId String
  roleId  String
  area    Area  @relation(fields: [areaId], references: [id])
  role    Role  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  shiftTypeRoleLocals ShiftTypeRoleLocal[]
  @@map("area_role")
}


model SalaryHistory {
  id        String   @id @default(uuid())
  userId    String
  amount    String
  currency  String   
  validFrom DateTime @db.Timestamptz(6) 
  validTo   DateTime? @db.Timestamptz(6) 
  comment   String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @db.Timestamptz(6)
  updatedBy String?  

  user      User     @relation(fields: [userId], references: [id])
  @@map("salary_history")
}


model ShiftType {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String?
  isRotative  Boolean  @default(false)
  isStandby   Boolean  @default(false)

  isActive    Boolean  @default(true)
  schedules   ShiftSchedule[]
  assignments ShiftAssignment[]
  roleLocals  ShiftTypeRoleLocal[]
  @@map("shift_type")
}

model ShiftSchedule {
  id          String   @id @default(uuid())
  shiftTypeId String
  dayOfWeek   Int?
  startTime   String
  endTime     String
  shiftType   ShiftType @relation(fields: [shiftTypeId], references: [id])
  @@map("shift_schedule")
}

model ShiftTypeRoleLocal {
  id             String @id @default(uuid())
  shiftTypeId    String
  areaRoleId     String
  shiftType      ShiftType @relation(fields: [shiftTypeId], references: [id])
  areaRole       AreaRole @relation(fields: [areaRoleId], references: [id])
  @@map("shift_type_role_local")
}

model ShiftAssignment {
  id                String   @id @default(uuid())
  userId            String
  shiftTypeId       String
  date              DateTime @db.Timestamptz(6)
  observation       String?
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @db.Timestamptz(6)
  originalUserId    String?
  isExtra           Boolean  @default(false)
  isCompleted       Boolean  @default(true)
  isHoliday         Boolean  @default(false)
  isWeekend         Boolean  @default(false)
  isStandby         Boolean  @default(false)
  areaId            String

  user              User     @relation("UserShiftAssignments", fields: [userId], references: [id])
  originalUser      User?    @relation("OriginalUser", fields: [originalUserId], references: [id])
  shiftType         ShiftType @relation(fields: [shiftTypeId], references: [id])
  area              Area     @relation(fields: [areaId], references: [id])

  events            ShiftEvent[]
  hours             ShiftHours?
  @@map("shift_assignment")
}

model ShiftHours {
  id                  String   @id @default(uuid())
  shiftAssignmentId   String   @unique
  worked              Int      @default(0)
  ordinary            Int      @default(0)
  extra               Int      @default(0)
  supplementary       Int      @default(0)
  shiftAssignment     ShiftAssignment @relation(fields: [shiftAssignmentId], references: [id])
  @@map("shift_hours")
}

model ShiftEvent {
  id              String   @id @default(uuid())
  shiftAssignmentId String
  userId          String
  eventType       String
  eventDate       DateTime @default(now()) @db.Timestamptz(6)
  observation     String?
  shiftAssignment ShiftAssignment @relation(fields: [shiftAssignmentId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
  @@map("shift_event")
}


model TechnicalLevel {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  users       UserTechnicalLevel[]
  @@map("technical_level")
}


model UserTechnicalLevel {
  id               String   @id @default(uuid())
  userId           String
  technicalLevelId String
  user             User           @relation(fields: [userId], references: [id])
  technicalLevel   TechnicalLevel @relation(fields: [technicalLevelId], references: [id])
  @@unique([userId, technicalLevelId])
  @@map("user_technical_level")   
}


model OrganizationalGroup {
  id             String   @id @default(uuid())
  name           String   
  description    String?
  areaId         String?  
  hierarchyLevel Int      @default(0) 
  groupType      GroupType @default(CONTAINER) 
  
  parentId       String?  
  parent         OrganizationalGroup? @relation("GroupHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children       OrganizationalGroup[] @relation("GroupHierarchy")

  containerGroupId String?
  containerGroup   OrganizationalGroup? @relation("GroupContainer", fields: [containerGroupId], references: [id], onDelete: SetNull)
  containedGroups  OrganizationalGroup[] @relation("GroupContainer")

  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @db.Timestamptz(6)
  
  
  area           Area?    @relation(fields: [areaId], references: [id], onDelete: Cascade)
  members        UserOrganizationalGroup[]
  
  @@map("organizational_group")
}

enum GroupType {
  CONTAINER    // Torre, División, Departamento, Equipo
  LEADERSHIP   // Jefatura, Coordinación, Líder
  OPERATIONAL  // Especialistas, Técnicos, Soporte
}

model UserOrganizationalGroup {
  id        String   @id @default(uuid())
  userId    String
  groupId   String
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group     OrganizationalGroup   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([userId, groupId])
  @@map("user_organizational_group")
}